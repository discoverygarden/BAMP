<?php
// $Id$

include 'bampcrud.wildtrip.inc';
include 'bampcrud.wildfish.inc';
include 'bampcrud.wildsites.inc';
include 'bampcrud.wildlab.inc';

/**
 * @file
 * Contains code for displaying list of reports
 */

/**
 * Set up permissions for module 
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_permission/7
 */
function bampcrud_permission() {
  return array(
    'Edit data'  => array(
      'title' => t('Edit data'),
      'description' => t('Allow user to edit BAMP data.'),
      'restrict access' => TRUE,
    ),
  );
}//end ireport_perm


/**
 * Drupal Menu Hook
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_menu/7
 */
function bampcrud_menu() {
  $items = array ();
  $items['bampcrud/crud'] = array(
    'title' => 'BAMP Data Management',
    'page callback' => 'bampcrud_menu_callback',
    'access callback' => 'user_access',
    'access arguments' => array('Edit data'),
    'weight' => '1',
  );
  $items['bampcrud/crud/wildsites'] = array(
    'title' => 'Manage Wild Sites',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bampcrud_wild_sites_form'),
    'access callback' => 'user_access',
    'access arguments' => array('Edit data'),
  );
  $items['bampcrud/crud/wildtrips'] = array(
    'title' => 'Manage Wild Trips',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bampcrud_wild_trips_form'),
    'access callback' => 'user_access',
    'access arguments' => array('Edit data'),
  );
  $items['bampcrud/crud/wildlab'] = array(
    'title' => 'Manage Wild Lab Results',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bampcrud_wild_lab_form'),
    'access callback' => 'user_access',
    'access arguments' => array('Edit data'),
  );
  $items['bampcrud/crud/wildfish'] = array(
    'title' => 'Manage Wild Fish Level',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bampcrud_wild_fish_form'),
    'access callback' => 'user_access',
    'access arguments' => array('Edit data'),
  );

  return $items;
}

function bampcrud_menu_callback() {
  drupal_set_title('BAMP Data Management');
  
  $content['form'] = array(
    '#markup' => '<p> This is the BAMP Data Management main menu. Please select an option from the menu on the left</p>',
  );  

  return $content;
}

function bampcrud_log($action, $table, $recordId, $additional){
  //Get the Drupal user ID
  global $user;
  $user = $user->name;

  //Handle logging based on which action is being performed (Create/Delete/Update)
  //Create - Logs an entry for each field/value pair. Transaction id placed in additional field for grouping output.
  //Delete - Creates a single entry with the recordId being deleted.
  //Update - Logs an entry for each field thats been changed with the old value and the new value. 
  switch($action){
    case 'Create':
      $transactionId = time();
      foreach($additional as $field=>$value){
        //Store the log information in the changelog table.
        $result = db_insert('changelog', array('target'=>'bamp_new'))
        ->fields(array(
          'user'=>$user,
          'action'=>$action,
          'dbtable'=>$table,
          'recordId'=>null,
          'field'=>$field,
          'oldvalue'=>null,
          'newvalue'=>$value,
          'additional'=>$transactionId,
        ))->execute(); 
      }//end foreach
    break;
    case 'Delete':
      //Grab existing record
      $results = db_query('SELECT * FROM {' . $table . '} WHERE id = :recordId ', array(':recordId' => $recordId), array('target' => 'bamp_new'));
      $oldRecord = $results->fetchAssoc();

      //Store the log information in the changelog table.
      $result = db_insert('changelog', array('target'=>'bamp_new'))
      ->fields(array(
        'user'=>$user,
        'action'=>$action,
        'dbtable'=>$table,
        'recordId'=>$recordId,
        'field'=>null,
        'oldvalue'=>null,
        'newvalue'=>null,
        'additional'=>serialize($oldRecord),
      ))->execute();
    break;
    case 'Update':
      //Grab existing record
      $results = db_query('SELECT * FROM {' . $table . '} WHERE id = :recordId ', array(':recordId' => $recordId), array('target' => 'bamp_new'));
      $oldRecord = $results->fetchAssoc();

      $transactionId = time();
      foreach($additional as $field=>$value){
        if($oldRecord[$field] != $value){
          //Store the log information in the changelog table.
          $result = db_insert('changelog', array('target'=>'bamp_new'))
          ->fields(array(
            'user'=>$user,
            'action'=>$action,
            'dbtable'=>$table,
            'recordId'=>$recordId,
            'field'=>$field,
            'oldvalue'=>$oldRecord[$field],
            'newvalue'=>$value,
            'additional'=>$transactionId,
          ))->execute();
        }//end if
      }//end foreach
    break;
  }//end switch


  /*/Store the log information in the changelog table.
  $result = db_insert('changelog', array('target'=>'bamp_new'))
  ->fields(array(
    'user'=>$user,
    'action'=>$action,
    'table'=>$table,
    'recordId'=>$recordId,
    'field'=>$field,
    'oldvalue'=>$oldvalue,
    'newvalue'=>$newvalue,
    'additional'=>$additional
  ))->execute();*/
}
