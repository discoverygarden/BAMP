<?php
// $Id$

/**
 * @file
 * Contains code for displaying list of reports
 */

/**
 * Set up permissions for module 
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_permission/7
 */
function ireport_perm() {
  return array('access ireport','administer ireport');
}//end ireport_perm


/**
 * Drupal Menu Hook
 * http://api.drupal.org/api/drupal/modules--system--system.api.php/function/hook_menu/7
 */
function ireport_menu()
{
  $items = array ();
  $items['ireport/view'] = array(
    'title' => 'View Reports',
    'page callback' => 'ireport_report_list',
    'access callback' => 'user_access',
    'access arguments' => array('input form'),
    'weight' => '1',
  );

  return $items;
}

/**
 * Contains returns views api version for views integration 
 * http://drupal.org/project/views
 */
function ireport_views_api() {
  return array('api' => 3.0);
}

function ireport_report_list() {
  $sql = "SELECT display_options FROM views_display WHERE display_plugin = 'page'";  

  $limit = 20;
  $header = array(
    array('data' => t('Title'), 'field' => 'display_title', 'sort' => 'asc'),
    array('data' => t('Description'), 'field' => 'company'),
    array('data' => t('View Report'), 'field' => 'city')
  );
  $result = db_query($sql);
  $rows = array();
  while($row = $result->fetchAssoc()) {
    $display_options = unserialize($row['display_options']);
    $title = $display_options['menu']['title'];
    $description = $display_options['menu']['description'];
    $link = l('View Report', $display_options['path']);

    $rows[] = array($title, $description, $link);
  }
  if (!$rows) {
    $rows[] = array(array('data' => t('No reports have been created yet.'), 'colspan' => 3));
  }

  $output = theme('table', array(
    'header' => $header, 
    'rows' => $rows,
  ));

  return $output;
}
